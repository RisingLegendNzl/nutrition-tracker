<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Nutrify</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <header class="app-header">
    <h1>Nutrify</h1>
    <nav class="tabs">
      <button id="tabDiet" class="tab active" aria-controls="dietPage">Diet</button>
      <button id="tabSupps" class="tab" aria-controls="suppsPage">Sup-Stack</button>
      <button id="tabHydro" class="tab" aria-controls="hydroPage">Hydration</button>
    </nav>
    <div id="daySwitcher" class="day-switcher">
      <button id="prevDay" class="ghost" aria-label="Previous day">Prev</button>
      <div id="dayName" class="day-name">Monday</div>
      <button id="nextDay" class="ghost" aria-label="Next day">Next</button>
    </div>
  </header>

  <!-- DIET PAGE -->
  <main id="dietPage">
    <section class="card">
      <h2 class="section-title">Meals</h2>
      <div id="meals"></div>
    </section>

    <section class="card">
      <h2 class="section-title">Remaining Today</h2>
      <div id="macroSummary" class="summary-row"></div>
      <div id="bars"></div>
      <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap">
        <button id="resetDiet" class="ghost small" aria-label="Reset today’s meals">Reset day</button>
        <button id="resetWeek" class="ghost small" aria-label="Reset the whole week">Reset week</button>
      </div>
    </section>
  </main>

  <!-- SUPPS PAGE -->
  <main id="suppsPage" class="hidden">
    <section class="card">
      <h2 class="section-title">Supplements</h2>
      <div id="suppList"></div>
      <div class="supp-actions">
        <button id="restoreDefaults" class="ghost small">Restore defaults</button>
      </div>
    </section>

    <!-- Add/Edit Sheet -->
    <div id="sheet" class="sheet hidden" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
      <div class="sheet-card">
        <h3 id="sheetTitle">Add supplement</h3>
        <form id="suppForm">
          <label class="field">
            <span>Name</span>
            <input id="fName" type="text" placeholder="e.g., Zinc"/>
          </label>

          <label class="field">
            <span>Dosage</span>
            <input id="fDose" type="text" placeholder="e.g., 25 mg"/>
          </label>
          <label class="field">
            <span>Timing</span>
            <input id="fTiming" type="text" placeholder="e.g., With breakfast"/>
          </label>
          <label class="field">
            <span>Pairs best with</span>
            <input id="fPairs" type="text" placeholder="e.g., Fat-containing meal"/>
          </label>
          <label class="field">
            <span>Notes</span>
            <textarea id="fNotes" rows="3" placeholder="e.g., Keep 2h away from iron"></textarea>
          </label>
          <div class="sheet-row">
            <button type="button" id="cancelSheet" class="ghost">Cancel</button>
            <button type="submit" id="saveSheet" class="primary">Save</button>
          </div>
        </form>
      </div>
    </div>

    <button id="addSupp" class="fab" aria-label="Add supplement">Add</button>

    <div id="snackbar" class="snackbar hidden">
      <span id="snackMsg"></span>
      <button id="undoBtn" class="link">Undo</button>
    </div>
  </main>

  <!-- HYDRATION PAGE -->
  <main id="hydroPage" class="hidden">
    <section class="card">
      <h2 class="section-title">Hydration</h2>

      <div class="hydro-goal-row">
        <div class="hydro-goal">
          <div class="hydro-goal-label">Daily goal</div>
          <button id="editGoalBtn" class="ghost small">Edit</button>
        </div>
        <div class="hydro-goal-values">
          <div><strong id="goalLitres">3.0</strong> L (<span id="goalMl">3000</span> ml)</div>
          <label class="switch small">
            <input id="autoGoal" type="checkbox">
            <span class="slider"></span>
          </label>
          <span class="auto-hint">Auto-goal (Creatine)</span>
        </div>
      </div>

      <!-- Animated bottle (with liquid waves) -->
      <div class="bottle-wrap">
        <div class="bottle">
  <!-- liquid fill (moves vertically via --fill) -->
  <div class="bottle-fill" id="bottleFill">
    <!-- SVG waves (continuous liquid look) -->
    <svg class="liq" viewBox="0 0 300 300" preserveAspectRatio="none">
      <!-- front wave -->
      <path class="wave w1"
        d="M0,190 C45,170 90,210 135,190 C180,170 225,210 270,190 L300,190 L300,300 L0,300 Z"/>
      <!-- back wave (different speed/phase) -->
      <path class="wave w2"
        d="M0,200 C60,180 120,220 180,200 C240,180 300,220 300,200 L300,300 L0,300 Z"/>
    </svg>
  </div>
  <div class="bottle-gloss"></div>
</div>
        <div class="hydro-numbers">
          <div id="todayStr" class="today-str">Today: 0 L / 0 L</div>
          <div id="pctStr" class="pct-str">0%</div>
        </div>
      </div>

      <div class="hydro-actions">
        <div class="quick-adds">
          <button class="ghost pill-btn" data-ml="250">+250 ml</button>
          <button class="ghost pill-btn" data-ml="500">+500 ml</button>
          <button class="ghost pill-btn" data-ml="750">+750 ml</button>
          <button class="ghost pill-btn" data-ml="1000">+1 L</button>
        </div>
        <div class="custom-add">
          <input id="customMl" type="number" inputmode="numeric" placeholder="Enter ml" />
          <button id="addCustom" class="primary">Add</button>
        </div>
        <div class="hydro-subrow">
          <button id="resetWater" class="ghost small">Reset today</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 class="section-title">Last 7 days</h2>
      <div id="hydroHistory" class="hydro-history"></div>
    </section>
  </main>

  <footer class="app-footer">
    <div class="tip">Diet: toggle meals to update remaining nutrients. Sup-Stack: track “taken today”. Hydration: log water and watch the fill rise.</div>
  </footer>

  <script src="data.js"></script>
  <script>
    /* =========================
       Helpers & Global State
       ========================= */
    const AEST_DATE = () =>
      new Date().toLocaleString("en-CA", { timeZone: "Australia/Brisbane" }).slice(0,10);
    const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));
    const toLitres = ml => (ml/1000).toFixed(2).replace(/\.00$/,'');
    const fromLitres = l => Math.round(parseFloat(l)*1000)||0;

    // DIET
    let dayIndex = 0;
    const days = Object.keys(mealPlan);
    const mealEaten = {};
    const openMeals = {};

    // SUPPS
    const DEFAULTS_KEY = "supps_defaults_v1";
    const SUPPS_KEY = "supps_v1";
    const TAKEN_PREFIX = "supps_taken_"; // + date
    const LAST_DATE_KEY = "last_seen_date_aest";
    let editingIndex = null;
    let lastDeleted = null;

    // HYDRATION
    const WATER_TARGET_KEY = "water_target_ml_v1";
    const WATER_AUTO_KEY   = "water_auto_goal_v1";
    const WATER_PREFIX     = "water_"; // + date
    const USER_WEIGHT_KG   = 71;

    // DOM – DIET
    const dayNameEl = document.getElementById("dayName");
    const mealsEl = document.getElementById("meals");
    const barsEl = document.getElementById("bars");
    const macroSummaryEl = document.getElementById("macroSummary");
    const prevBtn = document.getElementById("prevDay");
    const nextBtn = document.getElementById("nextDay");
    const daySwitcher = document.getElementById("daySwitcher");
    const resetDietBtn = document.getElementById("resetDiet");
    const resetWeekBtn = document.getElementById("resetWeek");

    // Tabs
    const tabDiet = document.getElementById("tabDiet");
    const tabSupps = document.getElementById("tabSupps");
    const tabHydro = document.getElementById("tabHydro");
    const dietPage = document.getElementById("dietPage");
    const suppsPage = document.getElementById("suppsPage");
    const hydroPage = document.getElementById("hydroPage");

    tabDiet.onclick  = () => setTab("diet");
    tabSupps.onclick = () => setTab("supps");
    tabHydro.onclick = () => setTab("hydro");

    function setTab(which){
      document.getElementById("sheet").classList.add("hidden");
      editingIndex = null;

      const showDiet = which==="diet";
      const showSupp = which==="supps";
      const showHydr = which==="hydro";
      tabDiet.classList.toggle("active", showDiet);
      tabSupps.classList.toggle("active", showSupp);
      tabHydro.classList.toggle("active", showHydr);
      dietPage.classList.toggle("hidden", !showDiet);
      suppsPage.classList.toggle("hidden", !showSupp);
      hydroPage.classList.toggle("hidden", !showHydr);
      daySwitcher.style.display = showDiet ? "flex" : "none";

      if (showSupp){ ensureToday(); renderSupps(); }
      if (showHydr){ ensureToday(); renderHydro(); }
      if (showDiet){ renderDiet(); }
    }

    /* ============= DIET ============= */
    prevBtn.addEventListener("click", () => { if (dayIndex>0){ dayIndex--; renderDiet(); } });
    nextBtn.addEventListener("click", () => { if (dayIndex<days.length-1){ dayIndex++; renderDiet(); } });

    resetDietBtn.addEventListener("click", ()=>{
      const day = days[dayIndex];
      mealEaten[day] = {};
      renderDiet();
      showSnack("Today’s meals have been reset.");
    });

    resetWeekBtn.addEventListener("click", ()=>{
      days.forEach(d => { mealEaten[d] = {}; });
      renderDiet();
      showSnack("All meals for the week have been reset.");
    });

    function renderDiet(){
      const day = days[dayIndex];
      const meals = mealPlan[day];
      dayNameEl.textContent = day;
      prevBtn.disabled = dayIndex===0; nextBtn.disabled = dayIndex===days.length-1;

      mealsEl.innerHTML = "";
      Object.entries(meals).forEach(([mealName, mealData]) => {
        const card = document.createElement("div");
        card.className = "meal-row";
        if (openMeals[day]?.[mealName]) card.classList.add("open");

        const rowBtn = document.createElement("div");
        rowBtn.className = "meal-title";
        rowBtn.innerHTML = `
          <div class="title-line">
            <span class="chev" aria-hidden="true"></span>
            <span class="meal-name">${mealName}</span>
          </div>
          <div class="meal-macros">${mealData.calories} kcal • ${mealData.protein} g protein • ${mealData.fibre} g fibre</div>
        `;
        rowBtn.addEventListener("click", () => {
          openMeals[day] = openMeals[day] || {};
          openMeals[day][mealName] = !openMeals[day][mealName];
          renderDiet();
        });

        const toggleWrap = document.createElement("label");
        toggleWrap.className = "switch";
        const input = document.createElement("input");
        input.type = "checkbox";
        input.checked = mealEaten[day]?.[mealName] || false;
        const slider = document.createElement("span");
        slider.className = "slider";
        toggleWrap.addEventListener("click", (e)=> e.stopPropagation());
        input.addEventListener("change", () => {
          mealEaten[day] = mealEaten[day] || {};
          mealEaten[day][mealName] = input.checked;
          updateNutrients();
        });
        toggleWrap.appendChild(input);
        toggleWrap.appendChild(slider);

        const top = document.createElement("div");
        top.className = "meal-top";
        top.appendChild(rowBtn);
        top.appendChild(toggleWrap);

        const details = document.createElement("div");
        details.className = "ingredients";
        if (mealData.ingredients?.length) {
          const ul = document.createElement("ul");
          mealData.ingredients.forEach(it => {
            const li = document.createElement("li");
            li.textContent = it;
            ul.appendChild(li);
          });
          details.appendChild(ul);
        }

        card.appendChild(top);
        card.appendChild(details);
        mealsEl.appendChild(card);
      });

      updateNutrients();
    }

    const goals = {
      calories: 3500, protein: 200, fibre: 30,
      iron: 8, zinc: 14, calcium: 1000,
      vitaminC: 45, folate: 400, potassium: 3800
    };

    function updateNutrients(){
      const day = days[dayIndex];
      const meals = mealPlan[day];
      const totals = Object.keys(goals).reduce((a,k)=>(a[k]=0,a),{});
      Object.entries(meals).forEach(([mName,mData])=>{
        if (!mealEaten[day]?.[mName]){
          for (const k in goals) totals[k] += mData[k] || 0;
        }
      });

      macroSummaryEl.innerHTML = `
        <div class="pill"><span>Calories</span><strong>${Math.round(totals.calories)}</strong></div>
        <div class="pill"><span>Protein</span><strong>${Math.round(totals.protein)} g</strong></div>
        <div class="pill"><span>Fibre</span><strong>${Math.round(totals.fibre)} g</strong></div>
      `;

      barsEl.innerHTML = "";
      Object.entries(goals).forEach(([k,goal])=>{
        const v = totals[k];
        const pct = Math.min(100, (v/goal)*100);
        const row = document.createElement("div");
        row.className = "bar-row";
        row.innerHTML = `
          <div class="bar-label">
            <span>${labelPretty(k)}</span>
            <span class="bar-value">${formatValue(k,v)} / ${formatValue(k,goal)}</span>
          </div>
          <div class="bar-outer"><div class="bar-inner" style="width:${pct}%"></div></div>
        `;
        barsEl.appendChild(row);
      });
    }

    function labelPretty(key){
      return {
        calories:"Calories", protein:"Protein", fibre:"Fibre", iron:"Iron", zinc:"Zinc",
        calcium:"Calcium", vitaminC:"Vitamin C", folate:"Folate", potassium:"Potassium"
      }[key] || key;
    }
    function formatValue(key,v){
      if (key==="calories") return Math.round(v)+" kcal";
      if (key==="protein"||key==="fibre") return Math.round(v)+" g";
      if (key==="iron"||key==="zinc") return v.toFixed(1)+" mg";
      if (key==="vitaminC") return Math.round(v)+" mg";
      if (key==="folate") return Math.round(v)+" µg";
      if (key==="calcium"||key==="potassium") return Math.round(v)+" mg";
      return v;
    }

    /* =========== SUPPS SUGGESTION ENGINE (unchanged) =========== */
    function baseSuggest(name){
      const key = name.trim().toLowerCase();
      for (const canon in SMART_SUGGESTIONS){
        const data = SMART_SUGGESTIONS[canon];
        if (canon.toLowerCase()===key || (data.aliases||[]).some(a => key.includes(a.toLowerCase()))){
          return { ...data };
        }
      }
      return {
        dose:"", timing:"With a meal",
        pairs:"Food (improves tolerance/absorption)",
        notes:"General guidance; adjust if you notice sensitivity.",
        why:"Complements your diet by filling potential micronutrient gaps."
      };
    }
    function resolveCanonicalName(inputStr){
      const s = inputStr.trim().toLowerCase();
      if (!s) return null;
      if (ALIAS_TO_CANON[s]) return ALIAS_TO_CANON[s];
      const hits = Object.keys(ALIAS_TO_CANON).filter(k => k.includes(s));
      if (hits.length) return ALIAS_TO_CANON[hits[0]];
      return null;
    }
    function suggestFor(name){
      const canon = resolveCanonicalName(name);
      if (canon && SMART_SUGGESTIONS[canon]) return { ...SMART_SUGGESTIONS[canon] };
      return baseSuggest(name);
    }

    /* =========== SUPPS TAB (unchanged core) =========== */
    const suppListEl = document.getElementById("suppList");
    const addSuppBtn = document.getElementById("addSupp");
    const restoreBtn = document.getElementById("restoreDefaults");
    const sheet = document.getElementById("sheet");
    const snack = document.getElementById("snackbar");
    const snackMsg = document.getElementById("snackMsg");
    const undoBtn = document.getElementById("undoBtn");

    const form = document.getElementById("suppForm");
    const fName = document.getElementById("fName");
    const fDose = document.getElementById("fDose");
    const fTiming = document.getElementById("fTiming");
    const fPairs = document.getElementById("fPairs");
    const fNotes = document.getElementById("fNotes");
    const cancelSheet = document.getElementById("cancelSheet");
    const saveSheet = document.getElementById("saveSheet");
    const sheetTitle = document.getElementById("sheetTitle");

    function loadSupps(){
      if (!localStorage.getItem(DEFAULTS_KEY)) {
        localStorage.setItem(DEFAULTS_KEY, JSON.stringify(defaultSupps));
      }
      if (!localStorage.getItem(SUPPS_KEY)) {
        localStorage.setItem(SUPPS_KEY, JSON.stringify(defaultSupps));
      }
      return JSON.parse(localStorage.getItem(SUPPS_KEY) || "[]");
    }
    function saveSupps(list){ localStorage.setItem(SUPPS_KEY, JSON.stringify(list)); }
    function dayKey(dateStr){ return TAKEN_PREFIX + dateStr; }
    function loadTakenMap(dateStr=AEST_DATE()){ return JSON.parse(localStorage.getItem(dayKey(dateStr)) || "{}"); }
    function saveTakenMap(map, dateStr=AEST_DATE()){ localStorage.setItem(dayKey(dateStr), JSON.stringify(map)); }

    function ensureToday(){
      const today = AEST_DATE();
      const last = localStorage.getItem(LAST_DATE_KEY);
      if (last !== today){
        localStorage.setItem(LAST_DATE_KEY, today);
        showSnack("New day detected — Sup-Stack and Hydration reset.");
      }
    }

    function renderSupps(){
      sheet.classList.add("hidden");
      editingIndex = null;

      const list = loadSupps();
      const taken = loadTakenMap();
      suppListEl.innerHTML = "";

      if (!Array.isArray(list) || list.length === 0) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.innerHTML = `
          <div class="empty-title">No supplements yet</div>
          <div class="empty-sub">Tap “Add” to create your Sup-Stack. You can restore defaults anytime.</div>
        `;
        suppListEl.appendChild(empty);
        return;
      }

      list.forEach((s, idx) => {
        const row = document.createElement("div");
        row.className = "supp-row";

        const left = document.createElement("div");
        left.className = "supp-left";
        left.innerHTML = `
          <div class="supp-title">${s.name}</div>
          <div class="supp-sub">${s.dose || ""} ${s.timing ? "• "+s.timing : ""}</div>
          <div class="supp-sub muted">
            ${s.pairs ? "Pairs: "+s.pairs : ""} ${s.why ? "• "+s.why : ""}
          </div>
          ${s.notes ? `<div class="supp-notes">${s.notes}</div>`:""}
        `;

        const toggle = document.createElement("label");
        toggle.className = "switch";
        const inp = document.createElement("input");
        inp.type = "checkbox";
        inp.checked = !!taken[s.name];
        const slid = document.createElement("span");
        slid.className = "slider";
        toggle.appendChild(inp); toggle.appendChild(slid);

        inp.addEventListener("change", ()=>{
          const m = loadTakenMap();
          if (inp.checked) m[s.name] = true; else delete m[s.name];
          saveTakenMap(m);
        });

        const menu = document.createElement("div");
        menu.className = "menu";
        menu.innerHTML = `
          <button class="menu-btn" aria-label="More">⋮</button>
          <div class="menu-sheet hidden">
            <button class="menu-item" data-act="edit">Edit</button>
            <button class="menu-item danger" data-act="delete">Delete</button>
            <button class="menu-item" data-act="info">Info</button>
          </div>
        `;
        const btn = menu.querySelector(".menu-btn");
        const sheetEl = menu.querySelector(".menu-sheet");
        btn.onclick = (e)=> {
          e.stopPropagation();
          sheetEl.classList.toggle("hidden");
          document.addEventListener("click", function docClose(ev){
            if (!menu.contains(ev.target)) { sheetEl.classList.add("hidden"); document.removeEventListener("click", docClose); }
          });
        };
        sheetEl.onclick = (e)=>{
          const act = e.target.getAttribute("data-act");
          if (!act) return;
          sheetEl.classList.add("hidden");
          if (act==="edit") openEditor(s, idx);
          if (act==="delete") doDelete(idx);
          if (act==="info") showInfo(s);
        };

        row.appendChild(left);
        const right = document.createElement("div");
        right.className = "supp-right";
        right.appendChild(toggle);
        right.appendChild(menu);
        row.appendChild(right);

        suppListEl.appendChild(row);
      });
    }

    function openEditor(s=null, idx=null){
      editingIndex = idx;
      if (s){
        sheetTitle.textContent = "Edit supplement";
        fName.value = s.name; fDose.value = s.dose||""; fTiming.value=s.timing||"";
        fPairs.value = s.pairs||""; fNotes.value = s.notes||"";
      } else {
        sheetTitle.textContent = "Add supplement";
        fName.value = ""; fDose.value=""; fTiming.value=""; fPairs.value=""; fNotes.value="";
      }
      sheet.classList.remove("hidden");
    }
    function closeEditor(){ sheet.classList.add("hidden"); }

    addSuppBtn.onclick = ()=> openEditor(null, null);
    cancelSheet.onclick = ()=> closeEditor();

    form.onsubmit = (e)=>{
      e.preventDefault();
      const name = fName.value.trim();
      if (!name){ fName.focus(); return; }

      let dose = fDose.value.trim();
      let timing = fTiming.value.trim();
      let pairs = fPairs.value.trim();
      let notes = fNotes.value.trim();
      let why = "";

      if (editingIndex===null){
        const sug = suggestFor(name);
        if (!dose) dose = sug.dose || "";
        if (!timing) timing = sug.timing || "";
        if (!pairs) pairs = sug.pairs || "";
        if (!notes) notes = sug.notes || "";
        why = sug.why || "";
      }

      const list = loadSupps();
      const exists = list.findIndex(x => x.name.toLowerCase() === name.toLowerCase());
      if (exists !== -1 && exists !== editingIndex){
        alert("A supplement with that name already exists.");
        return;
      }

      const obj = { name, dose, timing, pairs, notes, why: why || (list[editingIndex]?.why || "") };

      if (editingIndex===null){ list.unshift(obj); } else { list[editingIndex] = obj; }
      saveSupps(list);
      renderSupps();
      closeEditor();
    };

    function doDelete(idx){
      const list = loadSupps();
      lastDeleted = { item: list[idx], index: idx };
      list.splice(idx,1);
      saveSupps(list);
      renderSupps();
      showSnack(`Deleted ${lastDeleted.item.name}`);
    }

    function showInfo(s){
      const parts = [
        s.name,
        s.dose && `Dose: ${s.dose}`,
        s.timing && `Timing: ${s.timing}`,
        s.pairs && `Pairs best with: ${s.pairs}`,
        s.why && `Why: ${s.why}`,
        s.notes && `Notes: ${s.notes}`
      ].filter(Boolean).join("\n");
      alert(parts || s.name);
    }

    restoreBtn.onclick = ()=>{
      const defs = JSON.parse(localStorage.getItem(DEFAULTS_KEY) || "[]");
      const curr = loadSupps();
      const names = new Set(curr.map(x=>x.name.toLowerCase()));
      defs.forEach(d => { if (!names.has(d.name.toLowerCase())) curr.push(d); });
      saveSupps(curr);
      renderSupps();
      showSnack("Defaults restored");
    };

    /* ===== Snackbar ===== */
    function showSnack(msg){
      snackMsg.textContent = msg;
      snack.classList.remove("hidden");
      let to = setTimeout(()=> snack.classList.add("hidden"), 6000);
      undoBtn.onclick = ()=>{
        snack.classList.add("hidden");
        clearTimeout(to);
        if (lastDeleted){
          const list = loadSupps();
          const idx = Math.min(lastDeleted.index, list.length);
          list.splice(idx, 0, lastDeleted.item);
          saveSupps(list);
          renderSupps();
          lastDeleted = null;
        }
      };
    }

    // Typeahead setup (unchanged)...
    (function setupTypeahead(){
      const nameFieldWrapper = document.querySelector('#fName').parentElement;
      nameFieldWrapper.style.position = 'relative';
      const ta = document.createElement('div');
      ta.id = 'typeahead';
      ta.className = 'typeahead hidden';
      nameFieldWrapper.appendChild(ta);

      function suggestionsFor(inputStr, limit=6){
        const s = inputStr.trim().toLowerCase();
        if (!s) return [];
        const uniq = new Set();
        const results = [];
        const keys = Object.keys(ALIAS_TO_CANON);
        keys.forEach(key=>{
          const flat = key.replace(/[^a-z0-9]/g,'');
          const flatS = s.replace(/[^a-z0-9]/g,'');
          if (key.startsWith(s) || flat.startsWith(flatS)){
            const canon = ALIAS_TO_CANON[key];
            if (!uniq.has(canon)){ uniq.add(canon); results.push(canon); }
          }
        });
        keys.forEach(key=>{
          if (results.length>=limit) return;
          if (key.includes(s)){
            const canon = ALIAS_TO_CANON[key];
            if (!uniq.has(canon)){ uniq.add(canon); results.push(canon); }
          }
        });
        return results.slice(0, limit);
      }

      function showTypeahead(list){
        if (!list.length){ ta.classList.add('hidden'); ta.innerHTML=''; return; }
        ta.innerHTML = list.map(canon => `<button type="button" data-canon="${canon}">${canon}</button>`).join('');
        ta.classList.remove('hidden');
        [...ta.querySelectorAll('button')].forEach(btn=>{
          btn.onclick = ()=>{
            const canon = btn.getAttribute('data-canon');
            fName.value = canon;
            const sug = SMART_SUGGESTIONS[canon];
            if (sug){
              if (!fDose.value)   fDose.value   = sug.dose || '';
              if (!fTiming.value) fTiming.value = sug.timing || '';
              if (!fPairs.value)  fPairs.value  = sug.pairs || '';
              if (!fNotes.value)  fNotes.value  = sug.notes || '';
            }
            ta.classList.add('hidden'); ta.innerHTML='';
          };
        });
      }

      fName.addEventListener('input', ()=>{
        const list = suggestionsFor(fName.value);
        showTypeahead(list);
      });
      fName.addEventListener('blur', ()=> setTimeout(()=>{ ta.classList.add('hidden'); }, 150));
    })();

    /* =========== HYDRATION =========== */
    const goalLitresEl = document.getElementById('goalLitres');
    const goalMlEl = document.getElementById('goalMl');
    const editGoalBtn = document.getElementById('editGoalBtn');
    const autoGoalEl = document.getElementById('autoGoal');
    const bottleFill = document.getElementById('bottleFill');
    const todayStr = document.getElementById('todayStr');
    const pctStr = document.getElementById('pctStr');
    const quickBtns = document.querySelectorAll('.pill-btn');
    const customMl = document.getElementById('customMl');
    const addCustom = document.getElementById('addCustom');
    const resetWater = document.getElementById('resetWater');
    const hydroHistory = document.getElementById('hydroHistory');

    function waterKey(dateStr=AEST_DATE()){ return WATER_PREFIX + dateStr; }
    function loadWater(dateStr=AEST_DATE()){
      return JSON.parse(localStorage.getItem(waterKey(dateStr)) || '{"total_ml":0}');
    }
    function saveWater(total_ml, dateStr=AEST_DATE()){
      localStorage.setItem(waterKey(dateStr), JSON.stringify({ total_ml: Math.max(0,total_ml) }));
    }

    function takingCreatine(){
      try{
        const list = JSON.parse(localStorage.getItem(SUPPS_KEY) || "[]");
        return list.some(s => (s.name || "").toLowerCase().includes("creatine"));
      }catch{ return false; }
    }

    // ---- AUTO GOAL FIX (compat + live compute) ----
    function isAutoOn(){
      const v = localStorage.getItem(WATER_AUTO_KEY);
      return v === "1" || v === "true"; // accept old boolean strings
    }
    function computeAutoTargetMl(){
      const baseline = Math.round(USER_WEIGHT_KG * 35); // 35 ml/kg
      const bump = takingCreatine() ? 500 : 0;
      return Math.round((baseline + bump)/100)*100; // round to 100 ml
    }
    function currentTargetMl(){
      return isAutoOn() ? computeAutoTargetMl()
                        : (parseInt(localStorage.getItem(WATER_TARGET_KEY)||"0",10) || 3000);
    }
    function setTargetMl(ml){
      localStorage.setItem(WATER_TARGET_KEY, String(ml));
      localStorage.setItem(WATER_AUTO_KEY, "0"); // manual override
      renderHydro();
    }
    function setAutoGoal(on){
      localStorage.setItem(WATER_AUTO_KEY, on ? "1" : "0");
      renderHydro(); // recompute and update immediately
    }

    function addWater(ml){
      const w = loadWater();
      const tgt = currentTargetMl();
      const updated = clamp(w.total_ml + ml, 0, tgt*2);
      saveWater(updated);
      animateFill(updated, tgt);
      renderHydroNumbers(updated, tgt);
      renderHistory();
    }
    function resetTodayWater(){
      saveWater(0);
      renderHydro();
      showSnack("Hydration reset for today.");
    }

    // Liquid animation: we slide .bottle-fill and run two waves horizontally
    function animateFill(totalMl, targetMl){
      const pct = clamp((totalMl/targetMl)*100, 0, 100);
      // translateY from bottom: higher fill => smaller translate
      bottleFill.style.setProperty('--fill', pct + '%');
      pctStr.textContent = Math.round(pct) + '%';
    }
    function renderHydroNumbers(totalMl, targetMl){
      todayStr.textContent = `Today: ${toLitres(totalMl)} L / ${toLitres(targetMl)} L`;
      goalLitresEl.textContent = (targetMl/1000).toFixed(1).replace(/\.0$/,'');
      goalMlEl.textContent = targetMl;
      autoGoalEl.checked = isAutoOn();
    }

    function renderHistory(){
      const daysArr = [];
      const now = new Date(new Date().toLocaleString("en-US", { timeZone: "Australia/Brisbane" }));
      for (let i=6; i>=0; i--){
        const d = new Date(now); d.setDate(d.getDate()-i);
        const ds = new Date(d).toLocaleString("en-CA",{ timeZone:"Australia/Brisbane" }).slice(0,10);
        const total = loadWater(ds).total_ml || 0;
        const tgt = currentTargetMl();
        const pct = clamp((total/tgt)*100, 0, 100);
        daysArr.push({ label: ds.slice(5), pct });
      }
      hydroHistory.innerHTML = daysArr.map(({label,pct})=>`
        <div class="hbar">
          <div class="hbar-bar"><span style="height:${pct}%;"></span></div>
          <div class="hbar-lab">${label}</div>
        </div>
      `).join('');
    }

    function renderHydro(){
      const target = currentTargetMl();
      const { total_ml } = loadWater();
      renderHydroNumbers(total_ml, target);
      requestAnimationFrame(()=> animateFill(total_ml, target));
      renderHistory();
    }

    // Events
    editGoalBtn.onclick = ()=>{
      const current = currentTargetMl();
      const val = prompt("Set daily water goal (ml). Tip: 2500–4000 ml for most active days.", String(current));
      if (val===null) return;
      const ml = clamp(parseInt(val,10)||0, 500, 10000);
      setTargetMl(ml); // switches to manual mode
      showSnack(`Water goal set to ${ml} ml (manual).`);
    };
    autoGoalEl.onchange = ()=> setAutoGoal(autoGoalEl.checked);
    document.querySelectorAll('.pill-btn').forEach(b=>{
      b.addEventListener('click', ()=> addWater(parseInt(b.dataset.ml,10)));
    });
    addCustom.onclick = ()=>{
      const ml = Math.max(0, parseInt(customMl.value||"0",10));
      if (!ml) return; addWater(ml); customMl.value = "";
    };
    resetWater.onclick = ()=> resetTodayWater();

    /* ===== INIT & daily checks ===== */
    function init(){
      if (!localStorage.getItem(LAST_DATE_KEY)) localStorage.setItem(LAST_DATE_KEY, AEST_DATE());
      if (!localStorage.getItem(WATER_TARGET_KEY)) localStorage.setItem(WATER_TARGET_KEY, "3000");
      if (!localStorage.getItem(WATER_AUTO_KEY))   localStorage.setItem(WATER_AUTO_KEY, "0");

      renderDiet(); renderSupps(); renderHydro();
      setTab("diet");

      document.addEventListener("visibilitychange", ()=>{
        if (!document.hidden) { ensureToday(); if (!hydroPage.classList.contains('hidden')) renderHydro(); if (!suppsPage.classList.contains('hidden')) renderSupps(); }
      });
      setInterval(()=> {
        ensureToday();
        if (!hydroPage.classList.contains('hidden')) renderHydro();
        if (!suppsPage.classList.contains('hidden')) renderSupps();
      }, 60000);
    }
    init();
  </script>
</body>
</html>